{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/the-crimson-archive/lib/supabase/server.ts"],"sourcesContent":["import { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\r\nimport { createServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\n// -----------------------------------------------------------\r\n// 1. PRIMARY/DEFAULT CLIENT (Safe, Non-Cookie/Non-Session)\r\n// Use this for almost all API calls, especially for CRUD operations \r\n// on non-user data (e.g., fetching Games, Characters, Maps).\r\n// This is your standard, non-crashing client.\r\n// -----------------------------------------------------------\r\n\r\nexport function createClient() {\r\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n\r\n  if (!supabaseUrl || !supabaseServiceKey) {\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n    if (!supabaseUrl || !anonKey) {\r\n      throw new Error(\"Missing Supabase URL and keys\")\r\n    }\r\n    // Note: This falls back to the Anon Key client, which is safe.\r\n    return createSupabaseClient(supabaseUrl, anonKey)\r\n  }\r\n  // This is the powerful Service Role Client\r\n  return createSupabaseClient(supabaseUrl, supabaseServiceKey)\r\n}\r\n\r\n// -----------------------------------------------------------\r\n// 2. SESSION CLIENT (Cookie-Aware)\r\n// Use this ONLY for API calls where you MUST check the user's session \r\n// (e.g., /api/account, /api/auth/logout, or protected server actions).\r\n// -----------------------------------------------------------\r\n\r\nexport const createSessionClient = async () => { // ⬅️ RENAMED for clarity\r\n    const cookieStore = await cookies()\r\n    \r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n\r\n    if (!supabaseUrl || !anonKey) {\r\n        throw new Error(\"Missing Supabase URL or Anon Key for cookie client.\")\r\n    }\r\n\r\n    return createServerClient(\r\n        supabaseUrl,\r\n        anonKey,\r\n        {\r\n            cookies: {\r\n                get: (name: string) => cookieStore.get(name)?.value,\r\n                set: (name: string, value: string, options: any) => {\r\n                    cookieStore.set(name, value, options)\r\n                },\r\n                remove: (name: string, options: any) => {\r\n                    cookieStore.delete(name) \r\n                },\r\n            } as any, \r\n        }\r\n    )\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AAAA;AACA;;;;AASO,SAAS;IACd,MAAM;IACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;QACvC,MAAM;QACN;;QAGA,+DAA+D;QAC/D,OAAO,IAAA,yMAAoB,EAAC,aAAa;IAC3C;IACA,2CAA2C;IAC3C,OAAO,IAAA,yMAAoB,EAAC,aAAa;AAC3C;AAQO,MAAM,sBAAsB;IAC/B,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,MAAM;IACN,MAAM;IAEN;;IAIA,OAAO,IAAA,iMAAkB,EACrB,aACA,SACA;QACI,SAAS;YACL,KAAK,CAAC,OAAiB,YAAY,GAAG,CAAC,OAAO;YAC9C,KAAK,CAAC,MAAc,OAAe;gBAC/B,YAAY,GAAG,CAAC,MAAM,OAAO;YACjC;YACA,QAAQ,CAAC,MAAc;gBACnB,YAAY,MAAM,CAAC;YACvB;QACJ;IACJ;AAER"}},
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///D:/the-crimson-archive/app/api/ratings/route.ts"],"sourcesContent":["import { createClient, createSessionClient } from \"@/lib/supabase/server\"\r\nimport { type NextRequest, NextResponse } from \"next/server\"\r\n\r\n// Define the expected structure of the incoming rating data from the client\r\ninterface PostRatingBody {\r\n    gameId: string;\r\n    rating: number;\r\n    review?: string;\r\n    personalbest?: string;\r\n}\r\n\r\n/**\r\n * GET Handler: Fetches all ratings with joined data (returns lowercase keys as frontend expects).\r\n */\r\nexport async function GET(request: NextRequest) {\r\n    try {\r\n        const supabase = await createClient()\r\n\r\n        // CRITICAL: We select the necessary joins: games(title) and users(username)\r\n        const { data: ratings, error } = await supabase\r\n            .from(\"ratings\")\r\n            .select(\"*, games(gameid, title), users(userid, username)\")\r\n            .order(\"reviewtimestamp\", { ascending: false });\r\n\r\n        if (error) {\r\n            console.error(\"Supabase GET Error:\", error.message);\r\n            return NextResponse.json({ error: error.message }, { status: 500 })\r\n        }\r\n\r\n        // FIX: No mapping needed! The frontend expects the lowercase 'games' and 'users' returned by Supabase.\r\n        return NextResponse.json({ ratings }, { status: 200 })\r\n    } catch (error) {\r\n        console.error(\"Unhandled GET Error:\", error);\r\n        return NextResponse.json({ error: \"Failed to fetch ratings\" }, { status: 500 })\r\n    }\r\n}\r\n\r\n/**\r\n * POST Handler: Inserts a new rating, requiring authentication.\r\n */\r\nexport async function POST(request: NextRequest) {\r\n    const supabase = await createSessionClient()\r\n\r\n    try {\r\n        // 1. Get the authenticated user ID (MANDATORY)\r\n        const { data: { user }, error: userError } = await supabase.auth.getUser();\r\n\r\n        if (userError || !user) {\r\n            return NextResponse.json({ error: \"Authentication required.\" }, { status: 401 });\r\n        }\r\n\r\n        const userId = user.id;\r\n        const ratingData: PostRatingBody = await request.json()\r\n\r\n        // 2. Validation\r\n        if (!ratingData.rating || !ratingData.gameId) {\r\n            return NextResponse.json({ error: \"Rating score (1-5) and Game ID are required.\" }, { status: 400 })\r\n        }\r\n\r\n        const gameIdInt = parseInt(ratingData.gameId.toString(), 10);\r\n\r\n        if (isNaN(gameIdInt) || gameIdInt <= 0) {\r\n            return NextResponse.json({ error: \"Invalid Game ID provided.\" }, { status: 400 });\r\n        }\r\n\r\n        // 3. Construct the full payload\r\n        const insertPayload = {\r\n            userid: userId,\r\n            gameid: gameIdInt,\r\n            rating: ratingData.rating,\r\n            review: ratingData.review || null,\r\n            personalbest: ratingData.personalbest || null,\r\n            reviewtimestamp: new Date().toISOString(),\r\n        };\r\n\r\n        const { data, error } = await supabase\r\n            .from(\"ratings\")\r\n            .insert([insertPayload])\r\n            // CRITICAL: Select joined data on POST to return a fully populated object \r\n            .select(\"*, games(gameid, title), users(userid, username)\")\r\n            .single()\r\n\r\n        if (error) {\r\n            console.error(\"Supabase POST Error:\", error.message, error.details);\r\n            if (error.code === '23505') {\r\n                return NextResponse.json({ error: \"You have already reviewed this game.\" }, { status: 409 });\r\n            }\r\n            return NextResponse.json({ error: \"Database error: \" + error.message }, { status: 500 })\r\n        }\r\n\r\n        // FIX: No mapping needed here either! Return the raw Supabase output.\r\n        return NextResponse.json(data, { status: 201 })\r\n    } catch (error) {\r\n        console.error(\"Unhandled POST Error:\", error);\r\n        return NextResponse.json({ error: \"Failed to add rating\" }, { status: 500 })\r\n    }\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAaO,eAAe,IAAI,OAAoB;IAC1C,IAAI;QACA,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,4EAA4E;QAC5E,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,WACL,MAAM,CAAC,oDACP,KAAK,CAAC,mBAAmB;YAAE,WAAW;QAAM;QAEjD,IAAI,OAAO;YACP,QAAQ,KAAK,CAAC,uBAAuB,MAAM,OAAO;YAClD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,MAAM,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,uGAAuG;QACvG,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;QAAQ,GAAG;YAAE,QAAQ;QAAI;IACxD,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;IACjF;AACJ;AAKO,eAAe,KAAK,OAAoB;IAC3C,MAAM,WAAW,MAAM,IAAA,kJAAmB;IAE1C,IAAI;QACA,+CAA+C;QAC/C,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAExE,IAAI,aAAa,CAAC,MAAM;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAClF;QAEA,MAAM,SAAS,KAAK,EAAE;QACtB,MAAM,aAA6B,MAAM,QAAQ,IAAI;QAErD,gBAAgB;QAChB,IAAI,CAAC,WAAW,MAAM,IAAI,CAAC,WAAW,MAAM,EAAE;YAC1C,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA+C,GAAG;gBAAE,QAAQ;YAAI;QACtG;QAEA,MAAM,YAAY,SAAS,WAAW,MAAM,CAAC,QAAQ,IAAI;QAEzD,IAAI,MAAM,cAAc,aAAa,GAAG;YACpC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA4B,GAAG;gBAAE,QAAQ;YAAI;QACnF;QAEA,gCAAgC;QAChC,MAAM,gBAAgB;YAClB,QAAQ;YACR,QAAQ;YACR,QAAQ,WAAW,MAAM;YACzB,QAAQ,WAAW,MAAM,IAAI;YAC7B,cAAc,WAAW,YAAY,IAAI;YACzC,iBAAiB,IAAI,OAAO,WAAW;QAC3C;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SACzB,IAAI,CAAC,WACL,MAAM,CAAC;YAAC;SAAc,CACvB,2EAA2E;SAC1E,MAAM,CAAC,oDACP,MAAM;QAEX,IAAI,OAAO;YACP,QAAQ,KAAK,CAAC,wBAAwB,MAAM,OAAO,EAAE,MAAM,OAAO;YAClE,IAAI,MAAM,IAAI,KAAK,SAAS;gBACxB,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAuC,GAAG;oBAAE,QAAQ;gBAAI;YAC9F;YACA,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,qBAAqB,MAAM,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QAC1F;QAEA,sEAAsE;QACtE,OAAO,gJAAY,CAAC,IAAI,CAAC,MAAM;YAAE,QAAQ;QAAI;IACjD,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAuB,GAAG;YAAE,QAAQ;QAAI;IAC9E;AACJ"}}]
}