{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/the-crimson-archive/lib/supabase/server.ts"],"sourcesContent":["import { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\r\nimport { createServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\n// -----------------------------------------------------------\r\n// 1. PRIMARY/DEFAULT CLIENT (Safe, Non-Cookie/Non-Session)\r\n// Use this for almost all API calls, especially for CRUD operations \r\n// on non-user data (e.g., fetching Games, Characters, Maps).\r\n// This is your standard, non-crashing client.\r\n// -----------------------------------------------------------\r\n\r\nexport function createClient() {\r\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n\r\n  if (!supabaseUrl || !supabaseServiceKey) {\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n    if (!supabaseUrl || !anonKey) {\r\n      throw new Error(\"Missing Supabase URL and keys\")\r\n    }\r\n    // Note: This falls back to the Anon Key client, which is safe.\r\n    return createSupabaseClient(supabaseUrl, anonKey)\r\n  }\r\n  // This is the powerful Service Role Client\r\n  return createSupabaseClient(supabaseUrl, supabaseServiceKey)\r\n}\r\n\r\n// -----------------------------------------------------------\r\n// 2. SESSION CLIENT (Cookie-Aware)\r\n// Use this ONLY for API calls where you MUST check the user's session \r\n// (e.g., /api/account, /api/auth/logout, or protected server actions).\r\n// -----------------------------------------------------------\r\n\r\nexport const createSessionClient = async () => { // ⬅️ RENAMED for clarity\r\n    const cookieStore = await cookies()\r\n    \r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n\r\n    if (!supabaseUrl || !anonKey) {\r\n        throw new Error(\"Missing Supabase URL or Anon Key for cookie client.\")\r\n    }\r\n\r\n    return createServerClient(\r\n        supabaseUrl,\r\n        anonKey,\r\n        {\r\n            cookies: {\r\n                get: (name: string) => cookieStore.get(name)?.value,\r\n                set: (name: string, value: string, options: any) => {\r\n                    cookieStore.set(name, value, options)\r\n                },\r\n                remove: (name: string, options: any) => {\r\n                    cookieStore.delete(name) \r\n                },\r\n            } as any, \r\n        }\r\n    )\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AAAA;AACA;;;;AASO,SAAS;IACd,MAAM;IACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;QACvC,MAAM;QACN;;QAGA,+DAA+D;QAC/D,OAAO,IAAA,yMAAoB,EAAC,aAAa;IAC3C;IACA,2CAA2C;IAC3C,OAAO,IAAA,yMAAoB,EAAC,aAAa;AAC3C;AAQO,MAAM,sBAAsB;IAC/B,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,MAAM;IACN,MAAM;IAEN;;IAIA,OAAO,IAAA,iMAAkB,EACrB,aACA,SACA;QACI,SAAS;YACL,KAAK,CAAC,OAAiB,YAAY,GAAG,CAAC,OAAO;YAC9C,KAAK,CAAC,MAAc,OAAe;gBAC/B,YAAY,GAAG,CAAC,MAAM,OAAO;YACjC;YACA,QAAQ,CAAC,MAAc;gBACnB,YAAY,MAAM,CAAC;YACvB;QACJ;IACJ;AAER"}},
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///D:/the-crimson-archive/app/api/auth/signup/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\r\nimport { createClient } from \"@/lib/supabase/server\" \r\nimport { createClient as createAdminClient } from '@supabase/supabase-js'\r\n\r\n// --- Environment Variables Check Setup ---\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY; \r\n\r\n// This is the unified server-side route for handling user registration.\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        \r\n        // Configuration Check\r\n        if (!supabaseUrl || !supabaseServiceRoleKey) {\r\n            console.error(\"Missing Supabase environment variables: NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY\");\r\n            return NextResponse.json({ error: \"Configuration Error: Missing required Supabase API keys on server.\" }, { status: 500 });\r\n        }\r\n\r\n        const { email, password, username, isDev } = await request.json()\r\n\r\n        if (!email || !password || !username) {\r\n            return NextResponse.json({ error: \"Email, password, and username are required.\" }, { status: 400 })\r\n        }\r\n\r\n        // 1. Standard Client for Auth\r\n        const supabase = await createClient()\r\n\r\n        // 1. SUPABASE AUTH SIGN UP (Creates user in auth.users)\r\n        const { data: authData, error: authError } = await supabase.auth.signUp({\r\n            email,\r\n            password,\r\n            options: {\r\n                emailRedirectTo: `${request.nextUrl.origin}/auth/callback`,\r\n            },\r\n        })\r\n\r\n        if (authError) {\r\n            console.error(\"Supabase Auth Error:\", authError.message);\r\n            return NextResponse.json({ error: authError.message }, { status: 400 })\r\n        }\r\n        \r\n        const user = authData.user;\r\n        if (!user) {\r\n            return NextResponse.json({ error: \"Authentication succeeded, but user object is missing.\" }, { status: 500 })\r\n        }\r\n\r\n        // 2. PROFILE INSERTION (Synchronizes data to your custom 'users' table)\r\n        \r\n        // Use the Admin Client to bypass RLS\r\n        const adminSupabase = createAdminClient(supabaseUrl, supabaseServiceRoleKey, {\r\n            auth: {\r\n                autoRefreshToken: false,\r\n                persistSession: false,\r\n            }\r\n        });\r\n        \r\n        const { error: profileError } = await adminSupabase\r\n            .from('users') \r\n            .insert([\r\n                { \r\n                    userid: user.id, \r\n                    username: username, \r\n                    email: email, \r\n                    isdev: isDev ?? false,\r\n                    pfpurl: '/default-pfp.png', \r\n                },\r\n            ])\r\n\r\n        if (profileError) {\r\n            console.error(\"Supabase Profile Insertion Failed (DB Error):\", profileError.message);\r\n            \r\n            return NextResponse.json({ \r\n                error: `Account created, but profile synchronization failed. Database Error: ${profileError.message}`\r\n            }, { status: 500 })\r\n        }\r\n\r\n        // 3. SUCCESS\r\n        return NextResponse.json(\r\n            {\r\n                message: \"Success! Check your email for verification. Profile synchronized.\",\r\n                user: { id: user.id, email: user.email, username: username },\r\n            },\r\n            { status: 201 },\r\n        )\r\n    } catch (error) {\r\n        // This catch handles any unhandled system or dependency errors.\r\n        console.error(\"FATAL Internal Server Error in Sign-up API:\", error);\r\n        return NextResponse.json({ error: \"A fatal error occurred on the server. Please check terminal logs.\" }, { status: 500 })\r\n    }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,4CAA4C;AAC5C,MAAM;AACN,MAAM,yBAAyB,QAAQ,GAAG,CAAC,yBAAyB;AAG7D,eAAe,KAAK,OAAoB;IAC3C,IAAI;QAEA,sBAAsB;QACtB,IAAI,CAAC,eAAe,CAAC,wBAAwB;YACzC,QAAQ,KAAK,CAAC;YACd,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqE,GAAG;gBAAE,QAAQ;YAAI;QAC5H;QAEA,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,QAAQ,EAAE,KAAK,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE/D,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,UAAU;YAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA8C,GAAG;gBAAE,QAAQ;YAAI;QACrG;QAEA,8BAA8B;QAC9B,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,wDAAwD;QACxD,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,MAAM,CAAC;YACpE;YACA;YACA,SAAS;gBACL,iBAAiB,GAAG,QAAQ,OAAO,CAAC,MAAM,CAAC,cAAc,CAAC;YAC9D;QACJ;QAEA,IAAI,WAAW;YACX,QAAQ,KAAK,CAAC,wBAAwB,UAAU,OAAO;YACvD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,UAAU,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,MAAM,OAAO,SAAS,IAAI;QAC1B,IAAI,CAAC,MAAM;YACP,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAwD,GAAG;gBAAE,QAAQ;YAAI;QAC/G;QAEA,wEAAwE;QAExE,qCAAqC;QACrC,MAAM,gBAAgB,IAAA,yMAAiB,EAAC,aAAa,wBAAwB;YACzE,MAAM;gBACF,kBAAkB;gBAClB,gBAAgB;YACpB;QACJ;QAEA,MAAM,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,cACjC,IAAI,CAAC,SACL,MAAM,CAAC;YACJ;gBACI,QAAQ,KAAK,EAAE;gBACf,UAAU;gBACV,OAAO;gBACP,OAAO,SAAS;gBAChB,QAAQ;YACZ;SACH;QAEL,IAAI,cAAc;YACd,QAAQ,KAAK,CAAC,iDAAiD,aAAa,OAAO;YAEnF,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACrB,OAAO,CAAC,qEAAqE,EAAE,aAAa,OAAO,EAAE;YACzG,GAAG;gBAAE,QAAQ;YAAI;QACrB;QAEA,aAAa;QACb,OAAO,gJAAY,CAAC,IAAI,CACpB;YACI,SAAS;YACT,MAAM;gBAAE,IAAI,KAAK,EAAE;gBAAE,OAAO,KAAK,KAAK;gBAAE,UAAU;YAAS;QAC/D,GACA;YAAE,QAAQ;QAAI;IAEtB,EAAE,OAAO,OAAO;QACZ,gEAAgE;QAChE,QAAQ,KAAK,CAAC,+CAA+C;QAC7D,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAoE,GAAG;YAAE,QAAQ;QAAI;IAC3H;AACJ"}}]
}