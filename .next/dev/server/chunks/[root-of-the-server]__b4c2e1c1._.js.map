{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/the-crimson-archive/lib/supabase/server.ts"],"sourcesContent":["import { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\r\nimport { createServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\n// -----------------------------------------------------------\r\n// 1. PRIMARY/DEFAULT CLIENT (Safe, Non-Cookie/Non-Session)\r\n// Use this for almost all API calls, especially for CRUD operations \r\n// on non-user data (e.g., fetching Games, Characters, Maps).\r\n// This is your standard, non-crashing client.\r\n// -----------------------------------------------------------\r\n\r\nexport function createClient() {\r\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n\r\n  if (!supabaseUrl || !supabaseServiceKey) {\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n    if (!supabaseUrl || !anonKey) {\r\n      throw new Error(\"Missing Supabase URL and keys\")\r\n    }\r\n    // Note: This falls back to the Anon Key client, which is safe.\r\n    return createSupabaseClient(supabaseUrl, anonKey)\r\n  }\r\n  // This is the powerful Service Role Client\r\n  return createSupabaseClient(supabaseUrl, supabaseServiceKey)\r\n}\r\n\r\n// -----------------------------------------------------------\r\n// 2. SESSION CLIENT (Cookie-Aware)\r\n// Use this ONLY for API calls where you MUST check the user's session \r\n// (e.g., /api/account, /api/auth/logout, or protected server actions).\r\n// -----------------------------------------------------------\r\n\r\nexport const createSessionClient = async () => { // ⬅️ RENAMED for clarity\r\n    const cookieStore = await cookies()\r\n    \r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n\r\n    if (!supabaseUrl || !anonKey) {\r\n        throw new Error(\"Missing Supabase URL or Anon Key for cookie client.\")\r\n    }\r\n\r\n    return createServerClient(\r\n        supabaseUrl,\r\n        anonKey,\r\n        {\r\n            cookies: {\r\n                get: (name: string) => cookieStore.get(name)?.value,\r\n                set: (name: string, value: string, options: any) => {\r\n                    cookieStore.set(name, value, options)\r\n                },\r\n                remove: (name: string, options: any) => {\r\n                    cookieStore.delete(name) \r\n                },\r\n            } as any, \r\n        }\r\n    )\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AAAA;AACA;;;;AASO,SAAS;IACd,MAAM;IACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;QACvC,MAAM;QACN;;QAGA,+DAA+D;QAC/D,OAAO,IAAA,yMAAoB,EAAC,aAAa;IAC3C;IACA,2CAA2C;IAC3C,OAAO,IAAA,yMAAoB,EAAC,aAAa;AAC3C;AAQO,MAAM,sBAAsB;IAC/B,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,MAAM;IACN,MAAM;IAEN;;IAIA,OAAO,IAAA,iMAAkB,EACrB,aACA,SACA;QACI,SAAS;YACL,KAAK,CAAC,OAAiB,YAAY,GAAG,CAAC,OAAO;YAC9C,KAAK,CAAC,MAAc,OAAe;gBAC/B,YAAY,GAAG,CAAC,MAAM,OAAO;YACjC;YACA,QAAQ,CAAC,MAAc;gBACnB,YAAY,MAAM,CAAC;YACvB;QACJ;IACJ;AAER"}},
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///D:/the-crimson-archive/app/api/characters/%5BcharacterId%5D/route.ts"],"sourcesContent":["import { createClient, createSessionClient } from \"@/lib/supabase/server\";\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\n\r\n// --- GET Handler (Public Read) ---\r\n// FIX: Using robust parameter resolution to handle potential Promise<string> from Next.js dynamic routes.\r\nexport async function GET(request: NextRequest, { params }: { params: { characterId: string | Promise<string> } }) {\r\n  try {\r\n    const resolvedParams = await params; // Await params to ensure value is resolved\r\n    const characterIdStr = resolvedParams.characterId; // Access using the folder name [characterId]\r\n    const characterId = Number(characterIdStr);\r\n\r\n    if (!characterIdStr || isNaN(characterId)) {\r\n      return NextResponse.json({ error: \"Invalid character ID\" }, { status: 400 });\r\n    }\r\n    \r\n    // Use the unauthenticated client for public read\r\n    const supabase = await createClient() \r\n\r\n    // 2. Fetch the character.\r\n    const { data: character, error } = await supabase\r\n      .from(\"ingamecharacters\")\r\n      .select(\"*\")\r\n      .eq(\"characterid\", characterId)\r\n      .single()\r\n\r\n    if (error || !character) {\r\n      console.error(\"GET Character Error:\", error?.message || 'Character not found.');\r\n      return NextResponse.json({ error: \"Character not found\" }, { status: 404 })\r\n    }\r\n\r\n    return NextResponse.json(character, { status: 200 })\r\n  } catch (err) {\r\n    console.error(\"GET Character Exception:\", err);\r\n    return NextResponse.json({ error: \"Failed to fetch character\" }, { status: 500 })\r\n  }\r\n}\r\n\r\n// --- PUT Handler (Authenticated Update) ---\r\n// FIX: Using robust parameter resolution to handle potential Promise<string> from Next.js dynamic routes.\r\nexport async function PUT(request: NextRequest, { params }: { params: { characterId: string | Promise<string> } }) {\r\n  const supabase = await createSessionClient()\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n\r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized: User not authenticated.' }, { status: 401 });\r\n  }\r\n\r\n  try {\r\n    const resolvedParams = await params; // Await params to ensure value is resolved\r\n    const characterIdStr = resolvedParams.characterId; // Access using the folder name [characterId]\r\n    const characterId = Number(characterIdStr);\r\n    \r\n    const characterData = await request.json()\r\n    \r\n    // CRITICAL FIX FOR NaN ERROR: Validate parameter conversion immediately\r\n    if (isNaN(characterId) || !characterIdStr) {\r\n      return NextResponse.json({ error: \"Invalid character ID format in URL.\" }, { status: 400 });\r\n    }\r\n    \r\n    // 1. INPUT VALIDATION: Prevents 400 errors from malformed client data\r\n    if (Object.keys(characterData).length === 0) {\r\n      return NextResponse.json({ error: \"No update data provided.\" }, { status: 400 });\r\n    }\r\n    \r\n    // 2. Database Update\r\n    const { data, error } = await supabase\r\n      .from(\"ingamecharacters\")\r\n      .update(characterData)\r\n      .eq(\"characterid\", characterId)\r\n      .select()\r\n      .single()\r\n\r\n    if (error || !data) {\r\n      console.error(\"PUT Character DB Error:\", error?.message);\r\n      const status = error && error.message.includes('permission denied') ? 403 : 400;\r\n      return NextResponse.json({ error: `Failed to update character: ${error?.message || 'Data not found.'}` }, { status: status });\r\n    }\r\n\r\n    return NextResponse.json(data, { status: 200 })\r\n  } catch (err) {\r\n    console.error(\"PUT Character Exception:\", err);\r\n    return NextResponse.json({ error: \"Failed to update character\" }, { status: 500 })\r\n  }\r\n}\r\n\r\n// --- DELETE Handler (Authenticated Delete) ---\r\n// FIX: Using robust parameter resolution to handle potential Promise<string> from Next.js dynamic routes.\r\nexport async function DELETE(request: NextRequest, { params }: { params: { characterId: string | Promise<string> } }) {\r\n  const supabase = await createSessionClient()\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n  \r\n  if (authError || !user) {\r\n    return NextResponse.json({ error: 'Unauthorized: User not authenticated.' }, { status: 401 });\r\n  }\r\n  \r\n  try {\r\n    const resolvedParams = await params; // Await params to ensure value is resolved\r\n    const characterIdStr = resolvedParams.characterId; // Access using the folder name [characterId]\r\n    const characterId = Number(characterIdStr);\r\n    \r\n    // CRITICAL FIX FOR NaN ERROR: Validate parameter conversion immediately\r\n    if (isNaN(characterId) || !characterIdStr) {\r\n      return NextResponse.json({ error: \"Invalid character ID format in URL.\" }, { status: 400 });\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"ingamecharacters\")\r\n      .delete()\r\n      .eq(\"characterid\", characterId)\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error(\"DELETE Character DB Error:\", error.message);\r\n      const status = error.message.includes('permission denied') ? 403 : 400;\r\n      return NextResponse.json({ error: `Failed to delete character: ${error.message}` }, { status: status })\r\n    }\r\n\r\n    return NextResponse.json({ success: true, deleted: data }, { status: 200 })\r\n  } catch (err) {\r\n    console.error(\"DELETE Character Exception:\", err);\r\n    return NextResponse.json({ error: \"Failed to delete character\" }, { status: 500 })\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}