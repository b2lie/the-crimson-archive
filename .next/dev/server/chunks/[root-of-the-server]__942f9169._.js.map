{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/the-crimson-archive/lib/supabase/server.ts"],"sourcesContent":["import { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\r\nimport { createServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\n// -----------------------------------------------------------\r\n// 1. PRIMARY/DEFAULT CLIENT (Safe, Non-Cookie/Non-Session)\r\n// Use this for almost all API calls, especially for CRUD operations \r\n// on non-user data (e.g., fetching Games, Characters, Maps).\r\n// This is your standard, non-crashing client.\r\n// -----------------------------------------------------------\r\n\r\nexport function createClient() {\r\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n\r\n  if (!supabaseUrl || !supabaseServiceKey) {\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n    if (!supabaseUrl || !anonKey) {\r\n      throw new Error(\"Missing Supabase URL and keys\")\r\n    }\r\n    // Note: This falls back to the Anon Key client, which is safe.\r\n    return createSupabaseClient(supabaseUrl, anonKey)\r\n  }\r\n  // This is the powerful Service Role Client\r\n  return createSupabaseClient(supabaseUrl, supabaseServiceKey)\r\n}\r\n\r\n// -----------------------------------------------------------\r\n// 2. SESSION CLIENT (Cookie-Aware)\r\n// Use this ONLY for API calls where you MUST check the user's session \r\n// (e.g., /api/account, /api/auth/logout, or protected server actions).\r\n// -----------------------------------------------------------\r\n\r\nexport const createSessionClient = async () => { // ⬅️ RENAMED for clarity\r\n    const cookieStore = await cookies()\r\n    \r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n\r\n    if (!supabaseUrl || !anonKey) {\r\n        throw new Error(\"Missing Supabase URL or Anon Key for cookie client.\")\r\n    }\r\n\r\n    return createServerClient(\r\n        supabaseUrl,\r\n        anonKey,\r\n        {\r\n            cookies: {\r\n                get: (name: string) => cookieStore.get(name)?.value,\r\n                set: (name: string, value: string, options: any) => {\r\n                    cookieStore.set(name, value, options)\r\n                },\r\n                remove: (name: string, options: any) => {\r\n                    cookieStore.delete(name) \r\n                },\r\n            } as any, \r\n        }\r\n    )\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AAAA;AACA;;;;AASO,SAAS;IACd,MAAM;IACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;QACvC,MAAM;QACN;;QAGA,+DAA+D;QAC/D,OAAO,IAAA,yMAAoB,EAAC,aAAa;IAC3C;IACA,2CAA2C;IAC3C,OAAO,IAAA,yMAAoB,EAAC,aAAa;AAC3C;AAQO,MAAM,sBAAsB;IAC/B,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,MAAM;IACN,MAAM;IAEN;;IAIA,OAAO,IAAA,iMAAkB,EACrB,aACA,SACA;QACI,SAAS;YACL,KAAK,CAAC,OAAiB,YAAY,GAAG,CAAC,OAAO;YAC9C,KAAK,CAAC,MAAc,OAAe;gBAC/B,YAAY,GAAG,CAAC,MAAM,OAAO;YACjC;YACA,QAAQ,CAAC,MAAc;gBACnB,YAAY,MAAM,CAAC;YACvB;QACJ;IACJ;AAER"}},
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///D:/the-crimson-archive/app/api/account/pfp/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from 'next/server';\r\nimport { createSessionClient } from '@/lib/supabase/server'; \r\n\r\n// Define the structure of the profile expected by the client component (camelCase)\r\ninterface ClientProfile {\r\n    userID: string;\r\n    username: string;\r\n    email: string;\r\n    pfpURL: string;\r\n    isDev: boolean;\r\n    accountCreationDate: string;\r\n}\r\n\r\n// Define the structure of the user profile from the database (snake_case)\r\ninterface DatabaseProfile {\r\n    userid: string; \r\n    username: string;\r\n    email: string;\r\n    pfpurl: string; \r\n    isdev: boolean;\r\n    accountcreationdate: string;\r\n}\r\n\r\n// Helper to map database names to client names\r\nconst mapToClientProfile = (dbProfile: DatabaseProfile): ClientProfile => ({\r\n    userID: dbProfile.userid,\r\n    username: dbProfile.username,\r\n    email: dbProfile.email,\r\n    pfpURL: dbProfile.pfpurl,\r\n    isDev: dbProfile.isdev,\r\n    accountCreationDate: dbProfile.accountcreationdate,\r\n});\r\n\r\n\r\n// POST Handler (Handles file upload to Supabase Storage)\r\nexport async function POST(request: NextRequest) {\r\n    // 1. Initialize Supabase client and authenticate user\r\n    const supabase = await createSessionClient(); \r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n    if (authError || !user) {\r\n        return NextResponse.json({ error: 'Unauthorized: User not authenticated.' }, { status: 401 });\r\n    }\r\n    \r\n    try {\r\n        const formData = await request.formData();\r\n        const file = formData.get('file') as File;\r\n\r\n        if (!file) {\r\n            return NextResponse.json({ error: 'No file provided.' }, { status: 400 });\r\n        }\r\n        \r\n        const bucketName = 'avatars'; // Ensure this bucket exists in your Supabase project\r\n\r\n        // 2. Determine file path in storage\r\n        const fileName = `${user.id}-${Date.now()}`;\r\n        const fileExtensionMatch = file.name.match(/\\.([0-9a-z]+)$/i);\r\n        const fileExtension = fileExtensionMatch ? fileExtensionMatch[1] : 'jpg'; \r\n        const filePath = `${user.id}/${fileName}.${fileExtension}`;\r\n\r\n\r\n        // 3. Upload the file to Supabase Storage\r\n        const { error: uploadError } = await supabase.storage\r\n            .from(bucketName)\r\n            .upload(filePath, file, {\r\n                cacheControl: '3600', \r\n                upsert: true, \r\n                contentType: file.type \r\n            });\r\n\r\n        if (uploadError) {\r\n            console.error('Supabase Storage Upload Error:', uploadError.message, uploadError);\r\n            const errorMessage = uploadError.message.includes('permission denied')\r\n                ? 'Permission denied. Check your Supabase Storage RLS policies for the \"avatars\" bucket.'\r\n                : 'Failed to upload image to storage.';\r\n            return NextResponse.json({ error: errorMessage }, { status: 500 });\r\n        }\r\n\r\n        // 4. Get the public URL\r\n        const { data: { publicUrl } } = supabase.storage\r\n            .from(bucketName)\r\n            .getPublicUrl(filePath);\r\n\r\n        if (!publicUrl) {\r\n             return NextResponse.json({ error: 'Failed to retrieve public URL after upload.' }, { status: 500 });\r\n        }\r\n\r\n        // 5. Update the 'users' table with the new pfpurl\r\n        // We use .update() but skip the .select() part to prevent possible issues on some environments.\r\n        const { error: updateDbError } = await supabase\r\n            .from('users')\r\n            .update({ pfpurl: publicUrl })\r\n            .eq('userid', user.id); \r\n\r\n        if (updateDbError) {\r\n            console.error('Supabase Database Update Error:', updateDbError.message);\r\n            return NextResponse.json({ error: 'Failed to update profile picture URL in database.' }, { status: 500 });\r\n        }\r\n        \r\n        // 6. Dedicated SELECT: Fetch the latest profile data separately for safety\r\n        const { data: latestProfiles, error: fetchError } = await supabase\r\n            .from('users') \r\n            .select(`userid, username, email, pfpurl, isdev, accountcreationdate`) \r\n            .eq('userid', user.id) \r\n            .returns<DatabaseProfile[]>();\r\n        \r\n        if (fetchError || !latestProfiles || latestProfiles.length === 0) {\r\n            console.error('Final Profile Fetch Error:', fetchError?.message || 'No profile found.');\r\n            // Changed the error message to be more explicit about where the failure happened.\r\n            return NextResponse.json({ error: 'Profile URL updated, but failed to retrieve the final profile data.' }, { status: 500 });\r\n        }\r\n\r\n\r\n        // 7. Return the updated profile\r\n        return NextResponse.json(mapToClientProfile(latestProfiles[0]), { status: 200 });\r\n\r\n    } catch (e) {\r\n        console.error('API Error: Unhandled exception during PFP POST.', e);\r\n        return NextResponse.json({ error: 'Internal server error during upload.' }, { status: 500 });\r\n    }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAsBA,+CAA+C;AAC/C,MAAM,qBAAqB,CAAC,YAA8C,CAAC;QACvE,QAAQ,UAAU,MAAM;QACxB,UAAU,UAAU,QAAQ;QAC5B,OAAO,UAAU,KAAK;QACtB,QAAQ,UAAU,MAAM;QACxB,OAAO,UAAU,KAAK;QACtB,qBAAqB,UAAU,mBAAmB;IACtD,CAAC;AAIM,eAAe,KAAK,OAAoB;IAC3C,sDAAsD;IACtD,MAAM,WAAW,MAAM,IAAA,kJAAmB;IAC1C,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAExE,IAAI,aAAa,CAAC,MAAM;QACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwC,GAAG;YAAE,QAAQ;QAAI;IAC/F;IAEA,IAAI;QACA,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,CAAC,MAAM;YACP,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,MAAM,aAAa,WAAW,qDAAqD;QAEnF,oCAAoC;QACpC,MAAM,WAAW,GAAG,KAAK,EAAE,CAAC,CAAC,EAAE,KAAK,GAAG,IAAI;QAC3C,MAAM,qBAAqB,KAAK,IAAI,CAAC,KAAK,CAAC;QAC3C,MAAM,gBAAgB,qBAAqB,kBAAkB,CAAC,EAAE,GAAG;QACnE,MAAM,WAAW,GAAG,KAAK,EAAE,CAAC,CAAC,EAAE,SAAS,CAAC,EAAE,eAAe;QAG1D,yCAAyC;QACzC,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAAS,OAAO,CAChD,IAAI,CAAC,YACL,MAAM,CAAC,UAAU,MAAM;YACpB,cAAc;YACd,QAAQ;YACR,aAAa,KAAK,IAAI;QAC1B;QAEJ,IAAI,aAAa;YACb,QAAQ,KAAK,CAAC,kCAAkC,YAAY,OAAO,EAAE;YACrE,MAAM,eAAe,YAAY,OAAO,CAAC,QAAQ,CAAC,uBAC5C,0FACA;YACN,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAa,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,wBAAwB;QACxB,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,EAAE,GAAG,SAAS,OAAO,CAC3C,IAAI,CAAC,YACL,YAAY,CAAC;QAElB,IAAI,CAAC,WAAW;YACX,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA8C,GAAG;gBAAE,QAAQ;YAAI;QACtG;QAEA,kDAAkD;QAClD,gGAAgG;QAChG,MAAM,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,SACL,MAAM,CAAC;YAAE,QAAQ;QAAU,GAC3B,EAAE,CAAC,UAAU,KAAK,EAAE;QAEzB,IAAI,eAAe;YACf,QAAQ,KAAK,CAAC,mCAAmC,cAAc,OAAO;YACtE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoD,GAAG;gBAAE,QAAQ;YAAI;QAC3G;QAEA,2EAA2E;QAC3E,MAAM,EAAE,MAAM,cAAc,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SACrD,IAAI,CAAC,SACL,MAAM,CAAC,CAAC,2DAA2D,CAAC,EACpE,EAAE,CAAC,UAAU,KAAK,EAAE,EACpB,OAAO;QAEZ,IAAI,cAAc,CAAC,kBAAkB,eAAe,MAAM,KAAK,GAAG;YAC9D,QAAQ,KAAK,CAAC,8BAA8B,YAAY,WAAW;YACnE,kFAAkF;YAClF,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsE,GAAG;gBAAE,QAAQ;YAAI;QAC7H;QAGA,gCAAgC;QAChC,OAAO,gJAAY,CAAC,IAAI,CAAC,mBAAmB,cAAc,CAAC,EAAE,GAAG;YAAE,QAAQ;QAAI;IAElF,EAAE,OAAO,GAAG;QACR,QAAQ,KAAK,CAAC,mDAAmD;QACjE,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAuC,GAAG;YAAE,QAAQ;QAAI;IAC9F;AACJ"}}]
}