{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/the-crimson-archive/lib/supabase/server.ts"],"sourcesContent":["import { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\r\nimport { createServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\n// -----------------------------------------------------------\r\n// 1. PRIMARY/DEFAULT CLIENT (Safe, Non-Cookie/Non-Session)\r\n// Use this for almost all API calls, especially for CRUD operations \r\n// on non-user data (e.g., fetching Games, Characters, Maps).\r\n// This is your standard, non-crashing client.\r\n// -----------------------------------------------------------\r\n\r\nexport function createClient() {\r\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n  const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n\r\n  if (!supabaseUrl || !supabaseServiceKey) {\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n    if (!supabaseUrl || !anonKey) {\r\n      throw new Error(\"Missing Supabase URL and keys\")\r\n    }\r\n    // Note: This falls back to the Anon Key client, which is safe.\r\n    return createSupabaseClient(supabaseUrl, anonKey)\r\n  }\r\n  // This is the powerful Service Role Client\r\n  return createSupabaseClient(supabaseUrl, supabaseServiceKey)\r\n}\r\n\r\n// -----------------------------------------------------------\r\n// 2. SESSION CLIENT (Cookie-Aware)\r\n// Use this ONLY for API calls where you MUST check the user's session \r\n// (e.g., /api/account, /api/auth/logout, or protected server actions).\r\n// -----------------------------------------------------------\r\n\r\nexport const createSessionClient = async () => { // ⬅️ RENAMED for clarity\r\n    const cookieStore = await cookies()\r\n    \r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n\r\n    if (!supabaseUrl || !anonKey) {\r\n        throw new Error(\"Missing Supabase URL or Anon Key for cookie client.\")\r\n    }\r\n\r\n    return createServerClient(\r\n        supabaseUrl,\r\n        anonKey,\r\n        {\r\n            cookies: {\r\n                get: (name: string) => cookieStore.get(name)?.value,\r\n                set: (name: string, value: string, options: any) => {\r\n                    cookieStore.set(name, value, options)\r\n                },\r\n                remove: (name: string, options: any) => {\r\n                    cookieStore.delete(name) \r\n                },\r\n            } as any, \r\n        }\r\n    )\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AAAA;AACA;;;;AASO,SAAS;IACd,MAAM;IACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;IAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;QACvC,MAAM;QACN;;QAGA,+DAA+D;QAC/D,OAAO,IAAA,yMAAoB,EAAC,aAAa;IAC3C;IACA,2CAA2C;IAC3C,OAAO,IAAA,yMAAoB,EAAC,aAAa;AAC3C;AAQO,MAAM,sBAAsB;IAC/B,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,MAAM;IACN,MAAM;IAEN;;IAIA,OAAO,IAAA,iMAAkB,EACrB,aACA,SACA;QACI,SAAS;YACL,KAAK,CAAC,OAAiB,YAAY,GAAG,CAAC,OAAO;YAC9C,KAAK,CAAC,MAAc,OAAe;gBAC/B,YAAY,GAAG,CAAC,MAAM,OAAO;YACjC;YACA,QAAQ,CAAC,MAAc;gBACnB,YAAY,MAAM,CAAC;YACvB;QACJ;IACJ;AAER"}},
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///D:/the-crimson-archive/app/api/account/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from 'next/server';\r\nimport { createSessionClient } from '@/lib/supabase/server'; \r\n\r\n// Define the structure of the user object passed to the PUT request\r\ninterface UpdateProfilePayload {\r\n    username?: string;\r\n    email?: string;\r\n    isdev?: boolean;\r\n    accountcreationdate?: string;\r\n}\r\n\r\n// Define the structure of the user profile from the database (lowercase/snake_case)\r\ninterface DatabaseProfile {\r\n    userid: string; \r\n    username: string;\r\n    email: string;\r\n    pfpurl: string; \r\n    isdev: boolean;\r\n    accountcreationdate: string;\r\n}\r\n\r\n// Define the structure of the profile expected by the client component (camelCase)\r\ninterface ClientProfile {\r\n    userid: string;\r\n    username: string;\r\n    email: string;\r\n    pfpurl: string;\r\n    isdev: boolean;\r\n    accountcreationdate: string;\r\n}\r\n\r\n// Helper to map database names to client names\r\nconst mapToClientProfile = (dbProfile: DatabaseProfile): ClientProfile => ({\r\n    userid: dbProfile.userid,\r\n    username: dbProfile.username,\r\n    email: dbProfile.email,\r\n    pfpurl: dbProfile.pfpurl,\r\n    isdev: dbProfile.isdev,\r\n    accountcreationdate: dbProfile.accountcreationdate,\r\n});\r\n\r\n// =========================================================================\r\n// GET Handler (Fetches Profile)\r\n// =========================================================================\r\n\r\nexport async function GET(request: NextRequest) {\r\n    const supabase = await createSessionClient(); \r\n    \r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n    if (authError || !user) {\r\n        return NextResponse.json({ error: 'Unauthorized: User not authenticated.' }, { status: 401 });\r\n    }\r\n    \r\n    try {\r\n        const { data: profiles, error: dbError } = await supabase\r\n            .from('users') \r\n            .select(`userid, username, email, pfpurl, isdev, accountcreationdate`) \r\n            .eq('userid', user.id) \r\n            .returns<DatabaseProfile[]>(); \r\n\r\n        if (dbError) {\r\n            console.error('API Error: Supabase GET query failed.', dbError.message);\r\n            return NextResponse.json({ error: 'Database query failed.' }, { status: 500 });\r\n        }\r\n\r\n        if (!profiles || profiles.length === 0) {\r\n            return NextResponse.json({ error: 'Profile not found in database.' }, { status: 404 });\r\n        }\r\n        \r\n        return NextResponse.json(mapToClientProfile(profiles[0]), { status: 200 });\r\n\r\n    } catch (e) {\r\n        console.error('API Error: Unhandled exception during profile GET.', e);\r\n        return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\r\n    }\r\n}\r\n\r\n// =========================================================================\r\n// PUT Handler (Updates Profile)\r\n// =========================================================================\r\n\r\nexport async function PUT(request: NextRequest) {\r\n    const supabase = await createSessionClient();\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n    if (authError || !user) {\r\n        return NextResponse.json({ error: 'Unauthorized: User not authenticated.' }, { status: 401 });\r\n    }\r\n\r\n    try {\r\n        const payload: UpdateProfilePayload = await request.json();\r\n\r\n        if (Object.keys(payload).length === 0) {\r\n            return NextResponse.json({ error: 'No update data provided.' }, { status: 400 });\r\n        }\r\n\r\n        // 1. Separate Supabase Auth update (for email) from Profile table update\r\n        const profileUpdates: { username?: string, isdev?: boolean } = {};\r\n        const authUpdates: { email?: string } = {};\r\n\r\n        if (payload.username !== undefined) profileUpdates.username = payload.username;\r\n        if (payload.isdev !== undefined) profileUpdates.isdev = payload.isdev;\r\n        if (payload.email !== undefined) authUpdates.email = payload.email;\r\n\r\n\r\n        // 2. Handle Supabase Auth (Email) update\r\n        if (authUpdates.email) {\r\n            // This correctly uses the method available on the supabase client instance.\r\n            const { error: emailError } = await supabase.auth.updateUser(authUpdates);\r\n            \r\n            // Note: Supabase will send a confirmation email if the email is changed.\r\n            if (emailError) {\r\n                console.error(\"Supabase Auth Email Update Error:\", emailError);\r\n                // Return 400 if email is invalid or already in use\r\n                return NextResponse.json(\r\n                    { error: emailError.message || 'Failed to update email in Supabase Auth.' }, \r\n                    { status: 400 }\r\n                );\r\n            }\r\n        }\r\n\r\n        // 3. Handle Profile Table (username, role) update\r\n        if (Object.keys(profileUpdates).length > 0) {\r\n            const { data: updatedProfiles, error: dbError } = await supabase\r\n                .from('users')\r\n                .update(profileUpdates)\r\n                .eq('userid', user.id)\r\n                .select() // Select the updated row to return it\r\n                .returns<DatabaseProfile[]>();\r\n\r\n            if (dbError) {\r\n                console.error('API Error: Supabase PUT query failed.', dbError.message);\r\n                return NextResponse.json({ error: 'Failed to update profile data.' }, { status: 500 });\r\n            }\r\n\r\n            // Successfully updated and return the new profile\r\n            if (updatedProfiles && updatedProfiles.length > 0) {\r\n                return NextResponse.json(mapToClientProfile(updatedProfiles[0]), { status: 200 });\r\n            }\r\n        }\r\n        \r\n        // If only the email was updated (which returns no data from the 'users' table update),\r\n        // we need to re-fetch the profile to ensure the client has the most current state.\r\n        const { data: newProfile, error: refetchError } = await supabase\r\n            .from('users') \r\n            .select(`userid, username, email, pfpurl, isdev, accountcreationdate`) \r\n            .eq('userid', user.id) \r\n            .returns<DatabaseProfile[]>();\r\n        \r\n        if (refetchError || !newProfile || newProfile.length === 0) {\r\n            console.error('API Error: Profile refetch failed after email update.', refetchError?.message);\r\n             return NextResponse.json({ error: 'Profile updated, but failed to retrieve new profile data.' }, { status: 500 });\r\n        }\r\n\r\n\r\n        // Return the final, potentially updated profile (with new email status reflected)\r\n        return NextResponse.json(mapToClientProfile(newProfile[0]), { status: 200 });\r\n\r\n\r\n    } catch (e) {\r\n        console.error('API Error: Unhandled exception during profile PUT.', e);\r\n        return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\r\n    }\r\n}"],"names":[],"mappings":"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"}}]
}